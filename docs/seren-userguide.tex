\documentclass[a4paper]{article}
\usepackage{txfonts}
\usepackage[scaled=0.85]{luximono}
%\usepackage{subfigure}
%\RequirePackage{setspace}
%\usepackage{picins}
\usepackage{graphicx}
%\usepackage{psfig}
\usepackage{amssymb}
\usepackage{supertabular}
\usepackage{array}
%\usepackage[fleqn]{amsmath}
%\usepackage{fancyvrb}
%\usepackage{paralist}
%\usepackage{graphics,color}

\newcommand{\NAME}{SEREN }
\newcommand{\name}{seren}
\newcommand{\VERNO}{1.0.0 }

\newcommand{\var}[1]{\texttt{#1}}
%\newcommand{\p}[1]{\part*{\huge\MakeUppercase{#1}}}
%\newcommand{\s}[1]{\section{\LARGE\MakeUppercase{#1}}}
%\newcommand{\snn}[1]{\section*{\LARGE\MakeUppercase{#1}}}
%\newcommand{\subs}[1]{\subsection{\Large\MakeUppercase{#1}}}
%\newcommand{\subsnn}[1]{\subsection*{\Large\MakeUppercase{#1}}}
%\newcommand{\subsubs}[1]{\subsubsection{\Large\MakeUppercase{#1}}}
%\newcommand{\be}[1]{\begin{equation} \label{#1} }
%\newcommand{\beno}[1]{\begin{equation*} \label{#1} }
%\newcommand{\ee}{\end{equation}}
%\newcommand{\eeno}{\end{equation*}}
%\newcommand{\dv}{{\rm div}\,}
%\newcommand{\grad}{{\rm grad}\,}
%\newcommand{\curl}{{\rm curl}\,}
%\newcommand{\pd}[2]{\frac{\partial {#1}}{\partial {#2}}}
%\newcommand{\pds}[2]{\frac{\partial^2 {#1}}{\partial {#2}^2}}

\textheight 9.2in 
\textwidth 6.2in
\oddsidemargin 0pt
\topmargin -40pt

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{\NAME - Version 1.0.0}
\author{David Hubber, Christopher Batty \& Andrew McLeod}

\maketitle

%\newpage
\tableofcontents

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Overview}
\NAME is a Smoothed Particle Hydrodynamics (SPH) code designed for solving slef-gravitating hydrodynamical problems in astrophysics, particularly in the fields of star and planet formation.  \NAME largely grew from DRAGON, the star formation SPH code written by Simon Goodwin at Cardiff.  Although many routines have significantly diverged from the original DRAGON versions, there are still several features that have survived.  \NAME has also been designed to be compatible with DRAGON in its features and file formats. \newline

The basic elements of \NAME can be used to simulate any problem involving hydrodynamics and gravity, but \NAME also contains many specialized features for star formation problems.  The main features present in \NAME \VERNO  include : 
\begin{itemize}
\item Smoothed Particle Hydrodynamics (Standard SPH or conservative 'grad-h' SPH)
\item Self-gravitating SPH / N-body dynamics
\item Isothermal, barotropic or polytropic equations of state
\item Octal-spatial (Barnes-Hut) neighbour-searching and gravity tree
\item Simple sink particles (i.e. gravity only) or minimum-h value
\item Different particle types (gas, inter-cloud, boundary and CDM particles)
\item 1, 2 or 3 dimensions
\item Periodic boundary conditions (independent for each dimension) or spherical wall
\item Hierarchical block timesteps, with neighbour-checking for safety
\item Euler, 2nd order Runge-Kutta, Leapfrog-KDK, Leapfrog-DKD and 
Predictor-Corrector integration schemes
\item Artificial viscosity with Balsara switch, time-dependence and Keplerian pattern-matching
\item Artificial conductivity with switches
\item N-body evolution of sinks using 4th order Hermite integrator at termination of SPH
\item Radiative cooling approximation of Stamatellos et al. (2007)
\item Parallelized using OpenMP
\item Bash script to run automated batch tests
\item Output compatable with Splash
\end{itemize}

\noindent Features currently in development, or implemented but not full tested
\begin{itemize}
\item MPI parallelization (McLeod)
\item Combined radiative cooling and Flux-limited Diffusion (Stamatellos)
\item Sinks with smoother (non-integer) accretion of particles (Hubber, Walch \& Whitworth)
\item Re-distributing angular momentum in sink particles (Walch, Hubber \& Whitworth)
\item Hybrid 4th-order hermite-scheme for N-body integration combined with SPH for background gas evolution (Hubber)
\item Grouped particle tree walks (Hubber)
\item Ewald method for periodic gravity (McLeod \& Hubber)
\item Implement Riemann solver for all EOSs (Hubber)
\item Binary-mass tree (Whitworth \& Hubber)
\item Ionizing radiation with HEALPix (Bisbas \& Hubber)
\item Remove unconsequential outlying particles from simulation (Hubber)
\end{itemize}

%\newpage
\noindent Features planned for future versions include : 
\begin{itemize}
\item Physical viscosity
\item Jet feedback from protostars
\item Wind feedback from high-mass stars
\item 2nd fluid component (e.g for ion/dust particles) 
\item Particle Splitting 
\item Ideal/Non-ideal MHD 
\item Divergence cleaning/Euler potentials
\end{itemize}


\noindent Suspended/abandoned features (i.e. features implemented in the past where development has either been suspended, or abandoned but not removed from the code as of yet but may do so in the future)
\begin{itemize}
\item Ideal MHD
\end{itemize}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Using \NAME }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Obtaining \NAME via git}
\NAME can be obtained using {\it git} ({\rm http://git-scm.com/}), which is a new version-control software written by Linux-kernel author, Linus Torvalds.   Further information will be added here about using git, both to download \NAME and to automatically update it, in the near future.

%\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Compiling and running \NAME}
\NAME has been designed so to be compiled with \var{GNU make}.  
The user must specify a number of compiler options, which are set at the 
head of the Makefile (see Section \ref{SS:MAKEFILE} for more information). 
In order to compile, a compatible compiler must be specified in the 
first line of the Makefile.  
\NAME has been successfully tested on the following operating systems 
and compilers.  
\begin{itemize}
\item GNU/Linux
\begin{itemize}
\item \var{f95}      - NAG f95 compiler (Linux workstations)
\item \var{g95}      - g95 compiler (Linux workstations)
\item \var{gfortran} - GNU Fortran compiler (Linux workstations)
\item \var{ifort}    - Intel Fortran compiler (Merlin cluster)
\item \var{pgf90}    - Portland group Fortran compiler (Coma cluster)
\item \var{pgf95}    - Portland group Fortran compiler (Iceburg cluster)
\end{itemize}
\item Mac OS X (1.4, 1.5 \& 1.6)
\begin{itemize}
\item \var{g95}      - g95 compiler
\item \var{gfortran} - GNU Fortran compiler
\end{itemize}
\end{itemize}
Once all the other Makefile options have been set to their desired values, \NAME is compiled by \var{GNU make} with the command \newline

\var{make seren} \newline

\noindent \var{GNU make} will compile the source code of \NAME and produce the executable program \var{seren}.  Prior to performing a simulation, the user must set all simulation parameters in the file \var{params.dat} (See section \ref{SS:PARAMS} for more information) and provide an initial conditions file in the appropriate format. To run \NAME, the user must type \newline 

\var{./seren} \newline

\noindent \NAME will read in the default parameters file \var{params.dat} before performing the simulation.

%\var{./seren paramsfile} \newline

%\noindent where \var{paramsfile} is an optional argument that is the name of the parameters file to be read when \NAME is run.  If no argument is included, \NAME assumes the default parameters filename \var{params.dat} which is loaded automatically.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Command-line arguments}
\NAME has a number of optional command-line arguments that can be invoked to change the behaviour of the \NAME executable.  The behaviour can depend on several factors, particularly what Makefile options have been invoked while compiling \NAME.

\tablecaption{List of all command-line arguments available in \NAME}
\tablehead{\hline \bf{Argument} & \bf{Behaviour} \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{4.0cm}|p{8.0cm}|}
-d, -D & \NAME prints out the debug output column data format to screen and then exits without running any simulation. (N.B. The same information is printed to the \var{runid.params} file when a simulation is performed using \NAME) \\ \hline

-diag & \NAME prints out the column data format to screen of the diagnostics file (enabled with the -DDEBUG\_DIAGNOSTICS flag in the Makefile). \\ \hline

-h, -H, -help & \NAME prints out all available command-line options \\ \hline

-m, -M & \NAME prints out the Makefile options used to compile the code to screen and then exits without running any simulation.  (N.B. The same Makefile options are printed to the \var{runid.params} file when a simulation is performed using \NAME) \\ \hline

-s, -S, -sinks, -stars & \NAME prints out the column data format to screen for the sink files. \\ \hline

-v, -V, -version & \NAME prints out current version number \\ \hline

paramsfile & \NAME reads the parameters file \var{paramsfile} instead of the default \var{params.dat} \\ \hline

\end{supertabular}
\end{center}
\vspace{1cm}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Restarting simulations}
If a simulation is terminated for some reason, then it can be restarted by simply running \NAME without any modification to the \var{params.dat} file.  Each simulation generates a file \var{runid.restart} which contains the name of the last snapshot to be outputted.  \NAME will search for this file, and if it exists, it will read the snapshot name contained and restart the simulation from that point.  If you do not wish to restart the simulation from this point, but want a fresh run, then you should delete the \var{runid.restart} file.  If you wish to restart a simulation from a different snapshot, you can delete the \var{runid.restart} file and alter some of the parameters in the \var{params.dat} file, such as the \var{restart} logical flag (See Section \ref{SS:PARAMS}).  

\newpage




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Makefile} \label{SS:MAKEFILE}
The head of the Makefile contains the complete list of compilation variables that are available.  Most variables have two or more possible values which must be entered in the Makefile.  If an illegal value is entered, then \var{make} will halt during compilation, or the program will stop during runtime (see the routine \var{/main/sanitycheck.F90}).  The Makefile is technically split into two separate files; \var{Makefile}, which contains the user options, and \var{makefiletail.mk}, which processes all the selected options to compile the code.  The full list of all Makefile variables and possible options is given in the table below. 
\newline

%\vspace{1cm}
%\begin{center}
%\begin{tabular}{|l|ll|}
%\hline
%\bf{Variable} & \bf{Options} & \\
%\hline

\tablecaption{List of all available Makefile options in \NAME}
\tablehead{\hline \bf{Variable} & \bf{Options} & \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{4.6cm}|p{4.6cm} p{6.4cm}|}
 F90           & f95      :& NAG f95 compiler (Linux) \\
               & g95      :& free (not gnu) f95 compiler (Linux, Mac OS X)  \\
	       & gfortran :& gnu f95 compiler (Linux, Mac OS X) \\
               & pgf90    :& Portland Group compiler (Coma cluster) \\ 
               & mpif90   :& Portland Group compiler (Coma cluster) \\ 
	       & ifort    :& Intel Fortran compiler (Merlin cluster) \\ \hline

 VERSION\_NO   & & Version no. string \\ \hline

 SRCDIR        & & Absolute path of main SEREN directory (default {\var \$(PWD)/src}) \\ \hline

 EXEDIR        & & Absolute path of location for SEREN executable (default {\$(PWD)}) \\ \hline


 OPTIMISE      & 0 :& No compiler optimization  \\ 
               & 1 :& -O1 optimization \\
               & 2 :& -O2 optimization \\
               & 3 :& -O3 optimization \\ \hline

 OPENMP        & 0 :& Compile as serial code\\
               & 1 :& Compile using OpenMP directives \\ \hline

 PROFILE       & 0 :& No profiling\\
               & 1 :& Subroutine profiling (Invokes \var{-pg} option to be used by gprof) \\
               & 2 :& Line profiling (Invokes \var{-pg -g} options to be used by gprof and gdb)\\ \hline

 DEBUG         & 0 :& Debug flags switched off \\
               & 1 :& Debug flags switched on to level 1 \\
               & 2 :& Debug flags switched on to level 2 \\
               & 3 :& Debug flags switched on to level 3 \\ \hline

 NDIM          & 1 :& One-dimensional \\
               & 2 :& Two-dimensional \\
               & 3 :& Three-dimensional \\ \hline

 PRECISION     & SINGLE :& Single precision for main real variables \\
               & DOUBLE :& Double precision for main real variables \\ \hline

 INFILE\_FORMAT & ALL       :& Include routines to read all possible file formats \\
                & DRAGON    :& Only include DRAGON-format reading routines \\
                & SEREN     :& Only include SEREN-format reading routines \\
                & ASCII     :& Only include column-ASCII format reading routine \\ \hline

 OUTFILE\_FORMAT & ALL       :& Include routines to write all possible file formats \\
                 & DRAGON    :& Only include DRAGON-format writing routines \\
                 & SEREN     :& Only include SEREN-format writing routines \\ \hline

 PERIODIC      & 1 :& Periodic boundary conditions (Note : must be set to 1 if any of X\_BOUNDARY, Y\_BOUNDARY, Z\_BOUNDARY or SPHERICAL\_MIRROR are set to any value other than 0) \\
               & 0 :& No periodic boundary conditions \\ \hline

 X\_BOUNDARY   & PERIODIC :& Periodic box in x-dimension  \\
               & WALL     :& Walls in LHS and RHS directions of x-dimension \\
               & 0        :& No periodicity in x-dimension \\ \hline

 Y\_BOUNDARY   & PERIODIC :& Periodic box in y-dimension \\
               & WALL     :& Walls in LHS and RHS directions of y-dimension \\
               & 0        :& No periodicity in y-dimension \\ \hline

 Z\_BOUNDARY   & PERIODIC :& Periodic box in z-dimension \\
               & WALL     :& Walls in LHS and RHS directions of z-dimension \\
               & 0        :& No periodicity in z-dimension \\ \hline

 SPHERICAL\_MIRROR & 1 :& Spherical mirror to reflect particles that exceed some give radial distance \\
                   & 0 :& No spherical mirror \\ \hline

 CYLINDRICAL\_MIRROR & 1 :& Cylindrical mirror to reflect particles that exceed some given distance about z-axis \\
                   & 0 :& No spherical mirror \\ \hline

 SPH\_SIMULATION        & 1 :& Perform SPH simulation \\
                        & 0 :& No SPH simulation \\ \hline

 NBODY\_SPH\_SIMULATION & 1 :& Perform hybrid N-body/SPH simulation \\
                        & 0 :& No hybrid simulation \\ \hline

 NBODY\_SIMULATION      & 1 :& Perform N-body simulation \\
                        & 0 :& No N-body simulation \\ \hline

 SPH           & STANDARD       :& Use traditional SPH formulation (Monaghan 1992) \\
               & GRAD\_H\_SPH   :& Use 'grad-h' SPH formulation (Springel \& Hernquist 2002; Price \& Monaghan 2004) \\ \hline

 SPH\_INTEGRATOR & RK    :& 2nd order Runge-Kutta integration scheme \\
                 & LFKDK :& 2nd order Leapfrog kick-drift-kick scheme \\
                 & LFDKD :& 2nd order Leapfrog drift-kick-drift scheme \\
                 & PC    :& 2nd order Predictor-Corrector scheme \\ \hline

 KERNEL        & M4      :& M4 kernel (Monaghan \& Lattanzio 1985) \\
               & M4TC    :& M4 kernel with modifed 1st derivative (Thomas \& Couchman 1992) \\ 
               & QUINTIC :& Quitic kernel (Morris 1996) \\
               & QUINTICTC :& Quintic kernel with modified 1st derivative (c.f. Thomas \& Couchman 1992) \\
               & GAUSSIAN\_3H :& Gaussian kernel truncated at $3\,h$ \\ \hline

 HFIND         & NUMBER   :& Determine $h$ by number of neighbours \\
               & MASS     :& Determine $h$ by total mass of neighbours \\ 
               & CONSTANT :& Use contant smoothing length \\ \hline

 MINIMUM\_H    & 1 :& Set a minimum smoothing length \\
               & 0 :& Allow any smoothing length \\ \hline

 HYDRO         & 1 :& Hydro forces switched on \\
               & 0 :& No hydro forces \\ \hline

 THERMAL       & ISOTHERMAL    :& Isothermal equation of state \\
               & BAROTROPIC    :& Barotropic equations of state \\
               & POLYTROPIC    :& Polytropic equation of state \\ 
               & ENERGY\_EQN   :& Solve energy equation \\
               & CENTRAL\_STAR :& ... \\
               & RAD\_WS       :& Whitworth \& Stamatellos radiative transfer method  (Stamatellos et al. 2007)\\ \hline

 SINK\_POTENTIAL\_WS      & 1 :& Use gravitational potential from sink in radiative cooling calculations \\
                          & 0 :& Ignore gravitational potential from sinks for cooling \\ \hline

 AMBIENT\_HEATING\_WS     & 1 :& External ambient heating source (e.g. CMB)\\ 
                          & 0 :& No ambient heating \\ \hline

 SINK\_HEATING\_WS        & STAR\_HEATING :& \\ 
                          & STAR\_SIMPLE\_HEATING :& \\
                          & HDISC\_HEATING :& \\
                          & 0 :& \\ \hline

 FLUX\_LIMITED\_DIFFUSION & 1 :& Switch on flux-limited diffusion for hybrid radiation scheme (Forgan et al. 2009).  Only activated when THERMAL = RAD\_WS option is used (experimental). \\
                          & 0 :& No flux-limited diffusion \\ \hline

 IONIZING\_RADIATION & 0 :& No ionizing sources \\
                     & SINGLE\_STATIC\_SOURCE :& Single static source of ionizing radiation (Bisbas et al. 2009) \\
                     & MULTIPLE\_SINK\_SOURCES :& Sink particles act as sources of ionizing radiaiton (experimental) \\ \hline     

 RIEMANN\_SOLVER & 1   :& Use iterative Riemann solver (Van Leer 1977?, Cha \& Whitworth 2003).  Currently unstable and deactivated.\\
                 & 0   :& No Riemann solver \\ \hline

 ARTIFICIAL\_VISCOSITY  & MON97 :& Monaghan (1997) artificial viscosity \\
               & AB    :& Standard $\alpha$-$\beta$ viscosity (Monaghan \& Gingold 1983)\\
               & 0     :& No artificial viscosity \\ \hline

 VISC\_TD      & 1  :& Use time-dependent value of $\alpha$ (Morris \& Monaghan 1997)\\
               & 0  :& Constant value for $\alpha$ \\ \hline

 BALSARA       & 1  :& Use Balsara switch (Balsara 1995) \\
               & 0  :& No Balsara switch \\ \hline

 PATTERN\_REC  & 1 :& Use Keplarian pattern-matching (Cartwright \& Stamatellos 2010) \\
               & 0 :& Do not use pattern matching \\ \hline

 ARTIFICIAL\_CONDUCTIVITY  & 0         :& No artificial conductivity \\
                           & PRICE2008 :& Artificial conductivity with constant $\alpha_{_{\rm COND}}$ (Price 2008)\\ 
                           & WADSLEY2008 :& Wadsley et al. (2008) conductivity\\ \hline

 EXTERNAL\_PRESSURE & 0 :& No external pressure \\
                    & 1 :& Simple external pressure formulation \\ \hline

 MHD           & 0     :& No magnetic fields \\
               & IDEAL :& Ideal MHD (not functioning yet) \\ \hline

 INDUCTION\_EQN & 0        :& No induction equation \\
                & STANDARD :& Use standard induction equation \\ \hline

 RESISTIVITY   & 0  :& No artificial resistivity \\ \hline

 EXTERNAL\_FORCE & 0       :& No external forces \\
                 & PLUMMER :& Plummer sphere potential \\
                 & UDS     :& Uniform density sphere potential \\
                 & NFW1996 :& Navarro, Frenk \& White (1996) potential \\ \hline

 GRAVITY       & 0  :& No gravitational forces computed \\
	       & KS :& Kernel-softened gravity for 2-body forces \\
	       & NBODY :& Newton's gravitational law for all 2-body forces 
\\ \hline

 EWALD         & 1 :& Ewald periodic gravity switched on \\
               & 0 :& No Ewald corrections \\ \hline

 REMOVE\_OUTLIERS & 1 :& Remove outlying particles from the simulation (Experimental) \\
                  & 0 :& No removal of outliers \\ \hline

 SINKS         & 0  :& No sinks \\
               & SIMPLE :& Simple (i.e. only gravitating) sinks (Bate, Bonnell \& Price 1995)\\ 
               & NO\_ACC :& Simple sinks with no accretion \\
               & SMOOTH\_ACC :& Sinks with smooth accretion (experimental) \\ \hline

 SINK\_RADIUS  & FIXED\_ABSOLUTE :& Absolute value (in AU in params.dat file; same for all sinks) \\ 
               & FIXED\_HMULT    :& Multiple of mean h at sink density (same for all sinks) \\
               & HMULT           :& Multiple of h at sink density (individual values for sinks) \\ \hline

 SINK\_REMOVE\_ANGMOM & 1 :& Deposit sink ang. mom. on nearby particles (Experimental) \\
                      & 0 :& Sink particle retain ang. mom. of accreted particles \\ \hline

 SINK\_GRAVITY\_ONLY & 1 :& Only consider sinks are sources of gravity \\
                     & 0 :& Consider all physical sources of gravity \\ \hline

 NBODY\_INTEGRATION  & HERMITE4 :& 4th-order Hermite integration scheme (Makino \& Aarseth 1992)\\ \hline

 BINARY\_STATS & 1 :& Calculate binary statistics and output to file \\
               & 0 :& No binary calculations \\ \hline

 TREE          & 0      :& No tree (all quantities calculated by direct summation) \\
	       & BH     :& Use Barnes-Hut tree (octal-spatial; Barnes \& Hut 1985)\\
               & BINARY :& Use Binary-number tree (Not fully functioning yet) \\ \hline

 MULTIPOLE     & 0  :& No higher-order multipole terms \\
               & QUADRUPOLE :& Include quadrupole moment terms in gravity calculations \\
               & OCTUPOLE :& Include both octupole and quadrupole moment terms \\ \hline

 MAC           & GEOMETRIC :& Use standard Barnes-Hut geometric opening angle criterion (Barnes \& Hut 1985) \\
               & GADGET    :& Use Gadget-style higher-order moment criterion (Springel et al. 2002) \\
               & GADGET2   :& Use Gadget 2.0 moment criterion (Springel 2005) \\
               & EIGEN     :& Use Eigenvalues of Q tensor to compute appropriate MAC (Hubber et al. 2010)\\ \hline

 REORDER       & PARTICLES  :& Re-order particles in arrays according to tree-walk order  \\
               & 0   :& No re-ordering \\ \hline

 CELL\_WALK    & 1 :& Walk the tree with a group of particles (Experimental) \\
               & 0 :& Walk the tree with individual particles \\ \hline

 SORT          & INSERTION :& Use insertion sort for sorting lists \\
               & HEAP      :& Use heapsort for sorting lists\\ \hline

 TIMESTEP      & ADAPTIVE   :& Block timestep levels adjusted at resync \\
               & FIXED      :& Fixed block timestep levels, with maximum level set by the \var{dt\_fixed} parameter\\ 
               & RESTRICTED :& Timestep levels can only take certain values
                 (dt\_fixed parameter times integer power of 2), but are readjusted at resync \\ \hline

 CHECK\_NEIB\_TIMESTEP & 2 :& Ensure neighbours have similar timesteps \\
                       & 1 :& As option 2, but doesn't change timestep in middle of current step \\
                       & 0 :& No neighbour timestep comparison \\ \hline

 NEIGHBOURLISTS & 1 :& Store neighbour lists in memory \\
                & 0 :& Do not store neighbour lists in memory \\ \hline

 TIMING\_CODE  & 1 :& Use custom subroutines to produce timing statistics \\
               & 0 :& No timing output \\ \hline

 DIMENSIONLESS & 1 :& Dimensionless simulation (all scaling variables 
                      set to zero) \\
               & 0 :& Scaled variables (units specified in \var{params.dat})\\ \hline

 TEST          & FREEFALL :& Freefall collapse test \\
               & SPIEGEL  :& Spiegel (ref??) test \\
               & BINARY   :& Orbitting binary stars test \\
               & PLUMMER  :& Plummer sphere stability test \\
               & 0        :& No test flags \\ \hline

\end{supertabular}
\end{center}
\vspace{1cm}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Debug flags} \label{SS:PARAMS}
The \NAME Makefile contains a number of debug flags below the main options which can be switched on or off by uncommenting them or commenting them out.  Most of the debug flags produce verbose output of each routine, and in some cases produce extra files with more important information.  The full list of debugging options with additional output is shown in the table below.\newline

\tablecaption{List of special debugging options available in \NAME}
\tablehead{\hline \bf{Variable} & \bf{Options} \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{6cm}|p{8cm}|}
%\hline
%\bf{Variable} & \bf{Options} \\
%\hline
DEBUG\_DIV\_A               & \\
DEBUG\_ACCRETE              & \\
DEBUG\_ALLOCATE\_MEMORY     & \\
DEBUG\_BHTREEBUILD          & \\
DEBUG\_BHTREESTOCK          & \\
DEBUG\_BHTREEWALK           & \\
DEBUG\_BHTREEGRAVITY        & \\
DEBUG\_BINARYPROPERTIES     & Ouput binary properties to screen when calculated \\
DEBUG\_BINARY\_SEARCH       & \\
DEBUG\_BLOCK\_TIMESTEPS     & Outputs occcupation of timestep levels \\
DEBUG\_COPY\_PARTICLE\_DATA & \\
DEBUG\_CREATE\_SINK         & \\
DEBUG\_CREATE\_HP\_SOURCE   & \\
DEBUG\_DENSITY              & \\
DEBUG\_DIAGNOSTICS          & Output diagnostic in file 'run\_id.diag'\\
DEBUG\_DIV\_V               & \\
DEBUG\_DUDTRAD              & \\
DEBUG\_ENERGY\_EQN          & \\
DEBUG\_FOLIATE              & \\
DEBUG\_FORCES               & Records individual grav, hydro, magnetic forces\\
DEBUG\_FREEFALL             & \\
DEBUG\_GATHER\_NEIB         & \\
DEBUG\_GET\_NEIB            & \\
DEBUG\_GRAD\_H\_SPH         & \\
DEBUG\_HEAPSORT             & \\
DEBUG\_HERMITE4             & \\
DEBUG\_H\_GATHER            & \\
DEBUG\_H\_GATHER\_DENSITY   & \\
DEBUG\_H\_GUESS             & \\
DEBUG\_HP\_IF               & \\
DEBUG\_HP\_OUTPUT           & Outputs various ionization properties to files \\
DEBUG\_HP\_SPLIT\_ACTIVE\_RAYS & \\
DEBUG\_HP\_WALK\_ALL\_RAYS  & \\
DEBUG\_HP\_WALK\_RAY        & \\
DEBUG\_INTEGRATE            & \\
DEBUG\_KERNEL               & Outputs file 'kernel.dat' \\
DEBUG\_MHD                  & \\
DEBUG\_NBODYSETUP           & \\
DEBUG\_PARAMETERS           & \\
DEBUG\_PLOT\_DATA           & Outputs regular debug files with snapshot files.
                              Files are simple column-data files where the 
                              information of each column is written to the 
                              \var{run\_id.params} file.\\
DEBUG\_RAD                  & Outputs 'run\_id.rad' file for RAD\_WS tests \\
DEBUG\_REDUCE\_TIMESTEP     & \\
DEBUG\_REMOVE\_OUTLIERS     & \\
DEBUG\_RSPH\_OUTPUT         & Outputs files in RSPH format \\
DEBUG\_SINKCORRECTION       & \\
DEBUG\_SINK\_REMOVE\_ANGMOM & \\
DEBUG\_SINK\_SEARCH         & \\
DEBUG\_SINK\_TIMESTEP       & \\
DEBUG\_SKELETON             & \\
DEBUG\_SPH\_UPDATE          & \\
DEBUG\_SWAP\_PARTICLE\_DATA & \\
DEBUG\_TIMESTEP\_SIZE       & \\
DEBUG\_TRACK\_PARTICLE      & Outputs single file ('track1.dat') which 
                              contains large amount of information (same as 
                              that ouputted by debug files including the time) 
                              of one single chosen particle (set by parameter 
                              \var{ptrack} in \var{params.dat} file) which is 
                              printed every timestep. \\
DEBUG\_TREE\_BUILD          & \\
DEBUG\_TREE\_GRAVITY        & \\
DEBUG\_TREESTOCK            & \\
DEBUG\_TREEWALK             & \\
DEBUG\_TYPES                & \\
DEBUG\_VISC\_BALSARA        & \\
DEBUG\_VISC\_PATTERN\_REC   & \\
\end{supertabular}
\end{center}
%\caption{List of special debugging options available in \NAME}
%\end{center}
%\end{figure}

\vspace{1cm}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Parameter file} \label{SS:PARAMS}
Unlike DRAGON, \NAME contains all simulation information in a single parameter file, called \var{params.dat}.  The information contained in the parameters file in version 1.0 is shown in the following table. \newline

\tablecaption{List of user parameters in \NAME}
\tablehead{\hline \bf{Variable} & \bf{Type} & \bf{Description} \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}

%\begin{center}
%\begin{tabular}{|l|l|l|}
%\hline
%\bf{Variable} & \bf{Type} & \bf{Description}  \\
%\hline
\var{run\_id}    & char(256) & Run identifier string \\
\var{run\_dir}   & char(256) & Output directory name \\
\var{in\_file}   & char(256) & Name of initial conditions file \\
\var{in\_file\_form}  & char(50) & Format of initial conditions file \\
\var{out\_file\_form} & char(50) & Format of output snapshot files \\ \hline
\var{restart}    & logical  & Is this a restart or a new run? \\ 
\var{com\_frame} & logical  & Change to centre of mass frame? \\
\var{rseed}      & int      & Random number seed \\
\var{ptrack}     & int      & i.d. of tracked particle \\ \hline
\var{sph\_endtime}    & DP  & End time of SPH simulation \\
\var{nbody\_sph\_endtime} & DP & End time of hybrid N-body/SPH simulation \\
\var{nbody\_endtime} & DP   & End time of N-body simulation \\
\var{firstsnap}  & DP       & Time of first snapshot \\
\var{snaptime}   & DP       & Snapshot time interval (in real time) \\
\var{ntempstep}  & int      & Temporary snapshot interval (in integer steps) \\
\var{ndiagstep}  & int      & Integer time interval between diagnostic output \\
\var{nsinkstep}  & int      & Sink output time interval (in integer time) \\ 
\var{nsnapstep}  & int      & Snapshot time interval (in integer time) \\
\var{courant\_mult} & DP    & Courant timestep multiplication factor \\
\var{accel\_mult} & DP      & Acceleration timestep multiplication factor \\
\var{sink\_mult} & DP       & Sink accel. timestep multiplication factor \\
\var{nbody\_timemult} & DP  & Timestep factor for N-body simulations \\
\var{nlevels}    & int      & Number of multiple timestep levels \\
\var{dt\_fixed}  & DP       & Fixed ref. time for creating timestep levels \\ \hline
\var{runit}      & char(256) & Length scaling unit \\
\var{munit}      & char(256) & Mass scaling unit \\
\var{tunit}      & char(256) & Time scaling unit \\
\var{vunit}      & char(256) & Velocity scaling unit \\
\var{aunit}      & char(256) & Acceleration scaling unit \\
\var{rhounit}    & char(256) & Density scaling unit \\
\var{sigmaunit}  & char(256) & Column density scaling unit \\
\var{Punit}      & char(256) & Pressure scaling unit \\
\var{funit}      & char(256) & force scaling unit \\
\var{Eunit}      & char(256) & Energy scaling unit \\
\var{momunit}    & char(256) & Momentum scaling unit \\
\var{angmomunit} & char(256) & Angular momentum scaling unit \\
\var{angvelunit} & char(256) & Angular velocity scaling unit \\
\var{dmdtunit}   & char(256) & Accretion rate scaling unit \\
\var{Lunit}      & char(256) & Luminosity scaling unit \\
\var{kappaunit}  & char(256) & Opacity scaling unit \\
\var{Bunit}      & char(256) & Magnetic field (B-field) scaling unit \\
\var{Qunit}      & char(256) & Electric charge unit \\
\var{Junit}      & char(256) & Current density unit \\
\var{uunit}      & char(256) & Specific internal energy unit \\
\var{rscale}     & DP       & Length scaling factor \\
\var{mscale}     & DP       & Mass scaling factor \\ \hline
\var{periodic\_min(1)} & PR & Size of periodic box in x-dimension \\
\var{periodic\_max(1)} & PR & Size of periodic box in x-dimension \\
\var{periodic\_min(2)} & PR & Size of periodic box in y-dimension \\
\var{periodic\_max(2)} & PR & Size of periodic box in y-dimension \\
\var{periodic\_min(3)} & PR & Size of periodic box in z-dimension \\
\var{periodic\_max(3)} & PR & Size of periodic box in z-dimension \\ 
\var{rspheremax}       & PR & Radius of spherical wall \\ 
\var{psphere}    & int      & Mirror origin id (0 : co-ordinates origin; p : SPH particle; -s : sink particle) \\ \hline
%\end{tabular}
%\end{center}
%
%\begin{center}
%\begin{tabular}{|l|l|l|}
%\hline
%\bf{Variable} & \bf{Type} & \bf{Description} \\
%\hline
\var{pp\_gather} & int      & Neighbours required to determine $h$ \\
\var{hmin}       & PR       & Minimum allowed smoothing length \\
\var{h\_fac}     & PR       & grad-h density-h iteration factor \\ \hline
\var{isotemp}    & PR & Temperature for isothermal, barotropic EOSs (K) \\
\var{rhobary}    & PR & Adiabatic density for barotropic density (cgs units) \\
\var{gamma}      & PR & Ratio of specific heats \\
\var{mu\_bar}    & PR       & Mean gas particle mass (in a.m.u.) \\
\var{Kpoly}      & PR & Polytropic constant \\ 
\var{Pext}       & PR & External pressure \\ \hline
\var{alpha}      & PR       & $\alpha$-viscosity value \\
\var{beta}       & PR       & $\beta$-viscosity value \\
\var{alpha\_min} & PR       & Minimum value of $\alpha$ \\ \hline
\var{abserror}   & PR       & Absolute error fraction in GADGET MAC \\ 
\var{thetamaxsqd}& PR       & Maximum opening angle squared (Geometric MAC) \\
\var{nbuildstep} & int      & Frequency of DRAGON tree builds (in integer time units) \\ \hline
\var{rhosink}    & PR       & Sink formation density (cgs units) \\
\var{sinkrad}    & PR       & Sink radius (in units of $h$ or in AU depending on options) \\
\var{nsearchstep} & int     & No. of integer timesteps between sink search \\
\var{rho\_search} & logical & Calculate density for selecting sink candidates \\
\var{potmin\_search} & logical & Only consider particles at potential minimum \\
\var{hill\_sphere\_search} & logical & Hill spheres of sinks must not overlap \\
\var{energy\_search}  & logical & Only create sinks from bound objects \\
\var{div\_v\_search}  & logical & Only create sinks from converging objects \\
\var{div\_a\_search}  & logical & Do not create sinks if particles are accelerating apart \\
\var{timescale\_search} & logical & Compare timescales for sink formation \\ \hline
\var{energy\_accrete} & logical & Only accrete bound particles \\
\var{alpha\_ss}  & PR       & Sunyaev-Shakura viscosity parameter \\
\var{smooth\_accrete\_frac} & PR & Fraction of mass for instant accretion \\
\var{smooth\_accrete\_dt}   & PR & Timestep fraction for instant accretion \\
\var{f\_accretion}    & PR & Fraction of accretion energy radiated as luminosity \\
\var{feedback\_tdelay} & PR & Time delay between sink formation and feedback\\
\var{feedback\_minmass} & PR & \\ \hline
\var{nbody\_frac}     & PR & Fraction of mass accreted before switching to N-body \\ \hline
\var{ptemp0}     & PR & Disc temperature at $r = 1\,{\rm AU}$ from star (K) \\
\var{temp\_inf}  & PR & Disc temperature at infinity (K) \\
\var{ptemp\_r0}  & PR & Temperature softening radius ($\ll 1\,{\rm AU}$) \\
\var{ptemp\_q}   & PR & Temperature power law index \\
\var{fcolumn}    & PR & Column polytrope factor \\ \hline
\var{nionallstep}& int & Integer steps inbetween HEALPix walk \\
\var{f1}         & PR  & Integration step accuracy variable \\
\var{f2}         & PR  & HEALPix resolution factor \\
\var{f3}         & PR  & Temperature smoothing parameter \\
\var{f4}         & PR  & Density interpolation parameter \\
\var{Tneut}      & PR  & Temperarure of neutral gas \\
\var{Tion}       & PR  & Temperature of ionized gas \\
\var{Xfrac}      & PR  & Fraction of hydrogen \\
\var{a\_star}    & PR  & Recombination coefficient \\
\var{N\_LyC}     & PR  & No. of ionizing photons per second \\
\var{rstatic}    & PR(1:3) & Location of single static ionizing source \\
\var{lmax\_hp}   & PR  & Maximum allowed number of HEALPix levels \\
%\hline
\end{supertabular}
\end{center}
\vspace{1cm}


\newpage



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Generating initial conditions} \label{SS:ICS}
\NAME contains a large number of small programs which can be used to generate initial conditions to run simulations.  These programs are contained in the sub-directory \var{/\name/ic} and can be compiled.  To compile any initial conditions program of some name \var{ic\_name}, simply type \newline 

\var{make ic\_name} \newline

\noindent Some of the initial conditions programs require their own separate parameters file, a template of which can be found in the \var{\name/datafiles} sub-directory.  These parameters files must be copied into the main seren run directory in order to be accessed by the initial conditions program.  To run the initial conditions program, type \newline

\var{./ic\_name}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_BB}
\var{ic\_BB} sets-up the Boss-Bodenheimer test (Boss \& Bodenheimer 1979), i.e. a uniform density sphere with an azimuthal density perturbation in solid-body rotation.  Program reads in a unifrom density sphere of unit radius (centred at the origin), scales to the required density and radius, and then adds the azimuthal perturbation and a solid-body velocity field.  The original Boss-Bodenheimer test considered simply an isothermal EOS, but many subsequent studies have used barotropic and other EOSs.  Parameters read in from file \var{BBparams.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item SPH = STANDARD/GRAD\_H\_SPH
\item THERMAL = ISOTHERMAL/BAROTROPIC/RAD\_WS
\item HYDRO = 1
\item GRAVITY = KS
\item DIMENSIONLESS = 0
\end{itemize}
\vspace{0.1cm}

%\tablecaption{List of parameters for running ic\_BB in BBparams.dat}
\tablehead{\hline \bf{Variable} & \bf{Type} & \bf{Description} \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename (file containing uniform density sphere of unit radius) \\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
mass             & PR       & Mass of cloud \\
munit            & char(256) & Mass unit \\
rcloud           & PR       & Radius of cloud \\
runit            & char(256) & Length unit \\
temp\_cloud      & PR       & Temperature of cloud \\
angvel           & PR       & Angular velocity of cloud \\
angvelunit       & char(256) & Angular velocity unit \\
mpert            & integer  & Order of azimuthal perturbation (usually mpert=2) \\
amp              & PR       & Amplitude of density perturbation (usually 0.1 or 0.5)\\
\end{supertabular}
\end{center}


\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_core}
\var{ic\_core} creates a spherically symmetric density distribution for any given density function (as a function of radial distance).  Currently only contains the distribution for a plummer-like density profile and a radial power-law density function.  Requires the params file \var{core.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item HYDRO = 1
\item GRAVITY = KS
\item DIMENSIONLESS = 0
\end{itemize}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_jeans}
\var{ic\_jeans} sets-up the Jeans instability test (Hubber et al. 2006) which tests the ability of \NAME to resolve the Jeans gravitational instability.  Program reads in a relaxed unit cube (with the cube placed in positive octant) and stretches the particle distribution to produce a 1-D sinusoidal density perurbation.  Currently reads in parameters from the command line rather than via a separate parameters file. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item PERIODIC = 1
\item PERIODIC\_X = 1
\item PERIODIC\_Y = 1
\item PERIODIC\_Z = 1
\item SPH = STANDARD/GRAD\_H\_SPH
\item THERMAL = ISOTHERMAL
\item HYDRO = 1
\item GRAVITY = KS
\item EWALD = 1
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename (File containing unit-uniform density sphere)\\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
npert            & int       & No. of wavelengths \\
amp              & PR        & Amplitude of sinuosoidal perturbation \\
\end{supertabular}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_KH}
\var{ic\_KH} creates the initial conditions for the Kelvin-Helmholtz instability test.  Requires \var{KHparams.dat} file.  

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_lattice\_cube}
\var{ic\_lattice\_cube} creates a cubic-lattice distribution of particles with side-length \var{length} and \var{ppd} particles in each dimension.  Therefore the total number of particles in the lattice is $\var{ppd}^{\rm NDIM}$.  In 1-D, the program produces a uniformly-spaced line of particles, in 2-D a square-grid of particles, and in 3-D a cubic lattice.  The lattice extends from $0$ to $\var{length}$ in each dimension.  Parameters are currently read in from the command-line.  \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 1/2/3
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
ppd              & integer   & Particles per dimension in lattice (Must be a positive integer)\\
length           & PR        & Total length of lattice edge (For a unit cube, length = 1)\\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
\end{supertabular}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_NTSI}
\var{ic\_NTSI} generates the initial conditions for the non-linear thin-shell instability (NTSI) test.  Requires the parameters file \var{NTSIparams.dat}.


\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_polytrope}
Creates a finite polytrope/infinite polytrope with surrounding medium from a uniform-density sphere of unit radius centred at the origin.  For an isothermal polytrope (e.g. a Bonner-Ebert sphere), the inputted sphere is divided into 4 regions; the polytrope (self-gravitating gas), the gas envelope (self-gravitating gas), the surrounding inter-cloud medium (non-self gravitating gas) and a static outer-wall (boundary particles).  The outer-three regions are optional depending on the parameters selected in \var{polytrope.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item THERMAL = ISOTHERMAL/POLYTROPIC/BAROTROPIC
\item HYDRO = 1
\item GRAVITY = KS
\item DIMENSIONLESS = 0
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename (File containing unit-uniform density sphere)\\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
isocloud         & logical   & Flag true if isothermal polytrope (if true, THERMAL must equal ISOTHERMAL) \\
etapoly          & PR        & Polytropic index \\
xi\_bound        & PR        & Dimensionless cloud boundary (6.35 for a mariginally stable Bonner-Ebert sphere) \\
mpoly            & PR        & Mass of cloud \\
munit            & char(256)  & Mass unit (e.g. \var{m\_sun})\\
rho0             & PR        & Central density of cloud (Only if \var{mflag = rho0}) \\
rhounit          & char(256)  & Density unit \\
mflag            & char(20)  & Set the total mass (mass) or central density (rho0) of the polytrope \\
Kpoly            & PR        & Polytropic constant, or $a_0^2$ for isothermal polytrope \\
vunit            & char(256)  & Velocity unit (unit of isothermal speed of gas if isothermal polytrope is selected)\\
menvelope        & PR        & Mass of gas envelope around polytrope (distributed uniformly around the polytrope with the same density and pressure as the polytrope at its surface)\\
micm             & PR        & Mass of IcM envelope which surrounds gas (distributed uniformly around the polytrope/gas envelope with the same density and pressure as the polytrope at its surface)\\
hboundary        & PR        & Size of static boundary zone (in units of the mean smoothing length; should be 3 or 4 to ensure no edge effects occur for interior gas particles) \\
\end{supertabular}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_radtest}
\var{ic\_radtest} creates the initial conditions to perform the Masunaga-Inutsuka test (Masunaga \& Inutsuka ????) using the radiative cooling method of Stamatellos et al. (2007; RAD\_WS option).

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_random\_cube}
\var{ic\_random\_cube} creates a line, sheet or cube (depending on the dimensionality) of randomlly-placed particles.  Distributes particles between $0$ and \var{length} in each dimension. Parameters are currently read in from the command-line rather than a separate parameters file. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 1/2/3
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
ptot             & int       & Total number of particles \\
length           & PR        & Total length of lattice edge \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
\end{supertabular}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_replicate\_cubes}
Loads in a unit cube (from $0$ to $1$ in each dimension) and creates \var{nrepeat} periodic replicas in each dimension.  The larger cube is then scaled to a unit cube itself.  Used to create large-relaxed uniform density fields from smaller files.  Parameters are read in from the command-line rather than a separate parameters file. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 1/2/3
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename (File containing unit cube) \\
in\_file\_form   & char(256) & Input file format \\
nrepeat          & int       & No. of replicas in each dimension 
                               (must be a positive integer) \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
\end{supertabular}
\end{center}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_RT}
Generates initial conditions for Rayleigh-Taylor instability test.  Prepares two layers of gas with different densities in hydrostatuc balance on top of each other with a sinusoidal density perturbation to seed the instability.  A cubic grid of particles is generated rather than reading in a file.  Parameters are read in from the file \var{RTparams.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 2
\item PERIODIC = 1
\item PERIODIC\_X = 1
\item PERIODIC\_Y = 1
\item THERMAL = ENERGY\_EQN
\item HYDRO = 1
\item GRAVITY = 0
\item DIMENSIONLESS = 1
\end{itemize}


\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
out\_file         & char(256) & Output filename \\
out\_file\_form   & char(256) & Output file format \\
pertmode          & char(20)  & Perturbation mode (1=velocity, 2=boundary) \\
ppd1,ppd2         & int       & Particles per dimension \\
nlayers1,nlayers2 & int       & No. of layers of particles (in y-direction) \\
rho1,rho2         & PR        & Densities \\
Press1            & PR        & Pressure \\
acc\_grav         & PR        & External y-gravitational acceleration \\      
gamma             & PR        & Ratio of specific heats \\
xsize             & PR        & x.. \\
amp               & PR        & Amplitude of y-velocity perturbation \\
lambda            & PR        & Wavelength of perturbation \\
pp\_gather        & PR        & Required no. of SPH neighbours \\
hmin              & PR        & Minimum smoothing length \\
h\_fac            & PR        & 'grad-h' SPH factor \\
\end{supertabular}
\end{center}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_sedov}
Creates initial conditions for Sedov blast-wave test from inputted unit-uniform density sphere.  Requires inputting a unit-sphere.  A 'point-explosion' is added by giving the central particle and its neighbours a total energy of unity (weighted by the kernel from the centre, while the rest of the particles equally share an energy of total $10^{-6}$.  Parameters are read in from the file \var{sedovparams.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item PERIODIC = 0
\item PERIODIC\_X = 0
\item PERIODIC\_Y = 0
\item PERIODIC\_Z = 0
\item THERMAL = ENERGY\_EQN
\item HYDRO = 1
\item GRAVITY = 0
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename (File contains unit sphere)\\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
rho0             & PR        & Density of sphere \\
radius           & char(20)  & Radius of sphere after rescaling \\
\end{supertabular}
\end{center}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_shocktube}
Generates initial conditions for general 2-part shocktube tests (e.g. Sod 1978). Reads in two relaxed cubic density distribution, creates periodic replicas in the x-direction to elongate the shocktube and sets particle properties to create the desired test problem.  Parameters are read in from the file \var{sodparams.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 1/2/3
\item PERIODIC = 1
\item PERIODIC\_X = 1
\item PERIODIC\_Y = 1
\item PERIODIC\_Z = 1
\item THERMAL = ISOTHERMAL/ENERGY\_EQN
\item HYDRO = 1
\item ARTIFICIAL\_VISCOSITY = AB/MON97
\item GRAVITY = 0
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
file1            & char(256) & Input filename \\
file1\_form      & char(256) & Input file format \\
file2            & char(256) & Input filename \\
file2\_form      & char(256) & Input file format \\
p1, p2           & int, int  & No. of particles in file 1, 2 \\
n1, n2           & int, int  & No. of replicas for LHS/RHS \\
rho1, rho2       & PR, PR    & Density of LHS/RHS layers \\
Press1, Press2   & PR, PR    & Pressure for LHS/RHS \\
x1, x2           & PR, PR    & x \\
y1, y2           & PR, PR    & y \\
z1, z2           & PR, PR    & z \\
v1(1), v2(1)     & PR, PR    & vx \\
v1(2), v2(2)     & PR, PR    & vy \\
v1(3), v2(3)     & PR, PR    & vz \\
B1(1), B2(1)     & PR, PR    & Bx \\
B1(2), B2(2)     & PR, PR    & By \\
B1(3), B2(3)     & PR, PR    & Bz \\
\end{supertabular}
\end{center}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_sphere}
Creates a spherical distribution of particles of unit radius and centred on the origin containing an exact number of particles.  First, loads in a unit cube and then iterates to find the radius that contains the correct number of particles.  Finally the spherical cut is rescaled and placed at the origin.  Will fail to find the required number of particles if the inputted unit cube has too few particles.  Sphere parameters are read in from the file \var{sphereparams.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item PERIODIC = 0
\item PERIODIC\_X = 0
\item PERIODIC\_Y = 0
\item PERIODIC\_Z = 0
\item DIMENSIONLESS = 1
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename \\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
rcloud           & PR        & Required radius of sphere \\
nwant            & int       & Required number of particles in sphere \\
\end{supertabular}
\end{center}


\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ic\_vel\_pert.F90}
Adds a variety of perturbations to any inputted (spherical) density distribution.  Requires parameters file \var{velpert.dat}. \newline

\noindent Required Makefile options :
\begin{itemize}
\item NDIM = 3
\item DIMENSIONLESS = 0
\end{itemize}

\vspace{0.1cm}

\begin{center}
\begin{supertabular}{|p{3cm}|p{2cm}|p{8cm}|}
in\_file         & char(256) & Input filename \\
in\_file\_form   & char(256) & Input file format \\
out\_file        & char(256) & Output filename \\
out\_file\_form  & char(256) & Output file format \\
densmode         & char(20)  & Mode of density perturbation (not used yet) \\
amp              & PR        & Amplitude of azimuthal perturbation (not used yet) \\
mpert            & integer   & Azimuthal perturbation mode (not used yet) \\
fenhance         & PR        & Density enhancement factor (increase all particle masses by \var{fenhance}; used to make stable polytropes unstable)\\
vpower           & PR        & Turbulent velocity power spectrum index\\
eturb            & PR        & Ratio of turbulent to gravitational energy \\
ngrid            & integer   & No. of grid points for vel field 
                              (determines resolution of velocity field; 
                               must be a multiple of 2)  \\
iseed1           & integer   & Random No. seed 1 \\
iseed2           & integer   & Random No. seed 2 \\
velradmode       & char(20)  & Radial velocity mode (energy, dvdr or none) \\
dvdr             & PR        & Radial velocity gradient \\
erad             & PR        & Ratio of radial kinetic to gravitational energy \\
velrotmode       & char(20)  & Rotational mode (energy, angmom, angvel or none)\\
angmom           & PR        & Total angular momentum (if velrotmode = angmom) \\
angmomunit       & char(256)  & angular momentum unit \\
angpower         & PR        & Angular velocity power law 
                               (angular velocity is a function of axial 
                               distance, $\omega \propto r^{\var angpower}$)\\
angvel           & PR        & Angular velocity \\
angvelunit       & char(256)  & Angular velocity unit \\
erot             & PR        & Ratio of rotational kinetic energy to gravitational energy \\
\end{supertabular}
\end{center}


%For some of these programs, there is more information about how they work and what kind of initial conditions are generated by lookiing at the actual source code itself where there are numerous comments contained within.  Most of these programs also require a separate parameters file which the user sets to generate the desired initial conditions.  These separate parameter files are contained within the subdirectory \var{/\name/datafiles} and are usually contain the test name in their own name (e.g. for ic\_sedov, the


\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Running the \NAME bash test script}
\NAME contains a bash script designed to run batches of tests of \NAME for development and debugging purposes.  The script, and all related files for running the tests, is located in the \var{/\name/testsuite} sub-directory.  In the \var{testsuite} directory, there is the \var{test-seren.sh} bash script and further sub-directories which contain files used by \var{test-seren.sh} when performing batch tests. 

A test is launched from the command line as in the following example : \newline

\var{./test-seren.sh -gfortran -openmp -debug1 -test POLYRAD1-AB} \newline

The current list of command line options for the script are ({\bf TBD}) : 

The list of tests currently set-up for use with the test script are ({\bf TBD}) : 
\newline

\tablecaption{List of automated tests in \NAME}
\tablehead{\hline \bf{Test name} & \bf{Description} \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{3cm}|p{10cm}|}
ADSOD-3D & Classic SOD test of two initially static columns of gas in contact 
           which then interact  forming a shock. Gas is non-radiative so 
           the energy equation is solved and no energy  escapes the system
           (i.e. it is adiabatic). \\ \hline

BURRAU1  & Burrau 3-body problem (Burrau 19??); also known as the Pythagorean 
           problem.  Three stars with masses $3$, $4$ and $5$ placed on the 
           corners of a right-angled triangle all with zero-velocity and 
           allowed to evolve until the system dissolves into a single star 
           and a binary star. \\ \hline

COL-3D   & Two columns of uniform density gas collide supersonically to produce
           a dense shocked layer. \\ \hline

EIGEN1   & Gravitational force accuracy using eigenvalue MAC \\ \hline

FIGURE8  & Figure-8 3-body test for N-body integrator (????). \\ \hline

FREEFALL1 & Free-fall collapse test. \\ \hline

GEO1     & Gravitational force accuracy using geometric MAC \\ \hline

ISOFREEFALL1 & Isothermal free-fall collapse test \\ \hline

KH-2D    & 2D Kelvin-Helmholtz instability test \\ \hline

NTSI-2D  & 2D Non-linear thin shell instability test \\ \hline

POLYRAD1 & Masunaga \& Inutsuka (????) collapse test \\ \hline

SEDOV-3D & Sedov blast wave test (Sedov 19??). \\ \hline

SHEAR-2D & 2-D shearing layer test. \\ \hline

SIT1-AB  & A variation of the Boss-Bodenheimer (1979) test.  
           A uniform-density spherical cloud is given a sinusoidal azimuthal 
           density perturbation and a solid-body rotationaal velocity field 
           such that it collapses to form a dense filament with a star on 
           each end and eventually bound binary system. \\ \hline

STATPOLY1 & Relax a polytropic gas to hydrostatic balance. \\ \hline

\end{supertabular}
\end{center}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coding style of \NAME}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Design philosophy of \NAME}
\NAME is a highly modular code written in Fortran 90 which comprises of several layers of subroutine calls in performing basic simulations.  Each subroutine is designed to perform one single task.  If a long procedure consists of a number of independent steps (i.e. not using the same local variables), then it is broken down into a sequence of smaller subroutines.  Also, each \var{.F90} file contains one single subroutine (with the exception of \var{sanitycheck.F90} which has two extra smaller subroutines for clarity).

For the benefit of anyone reading through the source code, or for those wishing to develop new routines, we discuss here in detail some of the more important coding conventions that are used in \NAME.  We do not discuss the particular features of any one subroutine (since each routine is extensively commented), but focus on the style used in most subroutines of \NAME.  


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Macros} \label{SS:MACROS}
\NAME uses C-like macros throughout the source code, both for the clarity (by reducing the number of lines) and the efficiency and runtime speed of the code.  Macros are strings (conventionally in upper case as in C) which are substituted for some user-defined value or expression by the {\it pre-processor}, i.e. before the compiler generates machine code from the source code.  This can improve the runtime performance somewhat by removing common variable references.  

Macros are defined in two separate locations in \NAME.  Some are defined in the Makefile (e.g. \var{NDIM}). Most macros however are defined in the header file \var{/headers/macros.h}.  In order to make use of the macros, we must import the file \var{/headers/macros.h} into the subroutine by way of the pre-processor command \var{\#include ``macros.h''}.  The majority of macros in \NAME are straight-forward numerical substitutions of important information, such as array sizes or physical constants.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsubsection{Numerical macros}
%The majority of macros in \NAME are straight-forward numerical substitutions of important information, such as array sizes or physical constants.  Table \ref{TAB:MACROS} contains all of the important numerical macros used in SEREN (as defined in \var{/headers/macros.h}).  
%\newline

%\tablecaption{Table of numerical macros used in SEREN}
%\tablehead{\hline {\bf Macro name} & {\bf (Default) Values} & {\bf Purpose} \\ \hline}
%\tabletail{\hline}
%\tablelasttail{\hline}
%\begin{center}
%\begin{supertabular}{|p{4cm}|p{2cm}|p{7cm}|} \label{TAB:MACROS}
%NDIM             & 1, 2 or 3    & Number of dimensions.  The dimensionality 
%                                  of the code is an important compiler option,
%                                  and hence this is 
%                                  defined in  the Makefile.  \\ \hline
%MASS             & NDIM + 1     & Location of mass in grouped arrays \\ \hline
%SMOO             & NDIM + 2     & Location of smoothing length in 
%				  grouped arrays \\ \hline
%PI               & 3.1415926536 & The constant $\pi$ \\ \hline
%INVPI            & 0.318309886  & The reciprical of $\pi$ \\ \hline
%INVLOGETWO       & 1.442695041  & $1 / \ln{2}$ \\ \hline
%INVSQRTTWO       & 0.707106781  & $1 / \sqrt{2}$ \\ \hline 
%BIG\_NUMBER      & 9.9e30       & Large number \\ \hline
%SMALL\_NUMBER    & 1.0e-20      & Small number \\ \hline
%ETA\_SQD         & 0.01         & \\ \hline
%HMULT            & 1.1          & Multiplication factor in h-finding algorithm \\ \hline
%KERNTOT          & 10000        & Number of elements in kernel table \\ \hline
%HALFKERNTOT      & 5000.        & $\frac{1}{2}\,{\rm real}({\rm KERNTOT})$ \\ \hline
%KERNRANGE        & 2.           & Kernel extent in units of \var{h} \\ \hline
%INVKERNRANGE     & 0.5          & 1 / KERNRANGE \\ \hline
%C\_1             & 0.1          & TDV decay constant \\ \hline
%TVISC\_FAC       & 0.6          & \\ \hline
%BAL\_DENOM       & 1.e-4        & Dimensionless factor in denominator of Balsara term\\ \hline
%LEAFMAX          & +ve integer  & Maximum number of particles per leaf cell 
%				  in the tree \\ \hline
%LMAX             & 40           & Maximum number of levels in octal tree \\ \hline
%NCHILD           & +ve integer  & No. of child cells in BH tree\\ \hline
%NQUAD            & 5            & No. of quadrupole moment terms\\ \hline
%NOCT             & 10           & No. of octupole moment terms\\ \hline
%SMAX             & 100          & Maximum allowed number of sinks \\ \hline
%ITOT             & 30           & \\ \hline
%JTOT             & 30           & \\ \hline
%HFAC             & 1.2          & No. o particles per smoothing length \\ \hline
%H\_CON           & 0.01         & PM method convergence tolerance \\ \hline
%PM\_ITERATION\_MAX & 40         & Maximum number of iterations in PM method\\ \hline
%NBLOCKS          & 100          & Max no. of timing blocks\\ \hline
%LISTSIZE         & +ve integer  & Max no. of particles in neighbour interaction lists\\ \hline
%GLISTSIZE        & +ve integer  & Size if tree gravity buffer list\\ \hline
%CHUNKFRAC        & 0.005        & OpenMP chuck size for load balancing\\ \hline

%\end{supertabular}
%\end{center}


%%\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Function-like macros}
Function-like macros are macros that look like functions/subroutines by their syntax, but work by the substitution of a string of commands, rather than calling a subroutine elsewhere in memory (thereby eliminating the extra cost associated with a subroutine call).  In \NAME, we use function-like macros as a compact and concise way of writing debugging information to the screen when in debug mode.  For example, we define the \var{debug1} macro in the following way. \newline

\noindent \var{\#ifdef DEBUG1} \\
\var{\#define debug1(x)   write (6,*) x} \\
\var{\#else} \\
\var{\#define debug1(x)} \\
\var{\#endif} \newline

If we wished to write debug information to screen (e.g. in order to indicate the current location in the code), we could write in long-hand: \newline

\noindent \var{\#ifdef DEBUG1} \\ 
\var{write(6,*) ``Calculating smoothing lengths''} \\ 
\var{\#endif} \newline

In \NAME, we can instead write the short-hand form 
\newline

\noindent \var{debug1(``Calculating smoothing lengths'')} \\

If the DEBUG1 compiler flag is defined in the Makefile, then the 
\var{debug1()} macro is replaced with 
\var{write(6,*) ``Calculating smoothing lengths''}.  
If DEBUG1 is not defined in the Makefile, then \var{debug1()} macro is replaced with nothing. For subroutines (particularly those in development) that contain many debugging statements, these macros allow us to write code with more clarity and fewer lines. We use four levels of debug macros, which are all defined in \var{/headers/macros.h}. 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Real variable types} \label{SS:VARTYPES}
Rather than hard-wiring in the precision of real variables in the source code, \NAME allows the user to specify the precision through one of the options in the Makefile (PRECISION).  The precision is controlled by several lines in the module \var{definitions} (in \var{modules.F90}) : \newline

\indent \var{integer, parameter :: DP = selected\_real\_kind(p=15)} \\
\indent \var{integer, parameter :: SP = selected\_real\_kind(p=6)}  \\ 

\noindent \var{\#if defined(DOUBLE\_PRECISION)} \\
\indent \var{integer, parameter :: PR = DP} \\
\noindent \var{\#else}\\
\indent \var{integer, parameter :: PR = SP} \\
\noindent \var{\#endif}\\


\noindent The first two lines use the intrinsic \var{selected\_real\_kind} function to define the precision independent of the processor type (i.e. whether it is 32-bit or 64-bit).  The conditional compilation section then defines the precision used in the code (i.e. \var{PR}) depending on the option selected in the Makefile.  Any real variable in the code must be defined in the following way, e.g. \newline

\indent \var{real(kind=PR) :: drmag} \\

\noindent If we wish to declare a double or single precision variable irrespective of the general precision (e.g. any summation variables in \var{/main/diagnostics.F90} always use double precision), then we use \var{DP} or \var{SP} in place of \var{PR}. 

If we wish to convert a variable to a real variable of required precision, we must specify the kind (i.e. \var{PR}, \var{DP} or \var{SP}) as a second parameter in the \var{real} function, e.g. to convert the integer variable \var{i} to a real variable of precision \var{PR}, we write \newline

\indent \var{ireal = real(i,PR)} \\


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Particle data arrays} \label{SS:DATA}
\NAME mainly uses simple arrays to store particle data.  However, data which are important in gravity calculations are stored differently.  The position, mass and smoothing length information are grouped together in a single array, \var{parray(1:NDIM+2,1:ptot)}.  The position of particle \var{p} is stored in the elements \var{parray(1:NDIM,p)}, the mass is stored in the element \var{parray(MASS,p)}, and the smoothing length is stored in the element \var{parray(SMOO,p)} (See \var{/\name/headers/macros.h} for macro definitions). \newline


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Particle types}
\NAME accomodates the following particle types: 
\begin{itemize}
\item Static boundary particles (\var{pboundary})
\item Non-gravitating inter-cloud medium (IcM) particles (\var{picm})
\item Self-gravitating gas particles (\var{pgas})
\item Dark-matter particles (\var{pcdm})
\item Dust particles (\var{pdust})
\item Ion particles (\var{pion})
\item Sink particles (\var{stot})
\end{itemize}
where the variable names indicate the number of each particle type present 
in the simulation.  All data for the first three (boundary, IcM and self-gravitating gas particles) are stored in the main arrays, which contain \var{ptot} elements where $\var{ptot} = \var{pboundary} + \var{picm} + \var{pgas} + \var{pcdm}$.   
The data is stored such that the first \var{pboundary} elements contain the 
information for boundary particles, the next \var{picm} elements contain the 
information for the IcM particles, and the next \var{pgas} elements 
contain the information for the gas particles, and the final \var{pcdm} elements contain the information for the cdm particles.  Although provision has been made for their use in future versions of \NAME, dust and ion particles are not currently active.  


When using different particle types, care must be taken when looping over 
particles in the code.  If all particles are self-gravitating gas particles, 
then all loops would simply range from \var{1} to \var{ptot}, but with different types 
particles this is not always the case.  Consider some common examples: 
\begin{itemize}
\item Hydro forces - We only need to loop over all IcM and gas particles 
(since boundary particles do not move).  We therefore only loop from 
the first IcM particle (i.e. \var{p = pboundary + 1}) to the very last 
gas particle (i.e. \var{p = ptot}).  We therefore define the variable 
\newline

\var{phydrostart = pboundary + 1} \\

\noindent (in the subroutine \var{/main/types.F90}).  Any loops over 
hydro particles will thus range from \var{phydrostart} to \var{ptot}.

\item Gravitational forces - We only need to loop over all self-gravitating gas particles.  
As with hydro forces, we define the variable \newline 

\var{pgravitystart = pboundary + picm + 1} \\

in \var{/main/types.F90} which points to the first gas particle.  
Any loops over gravitating particles will thus range from 
\var{pgravitystart} to \var{ptot}.  
\end{itemize}

The sink particles are stored in separate data structures, since they can have many additional properties that are not possessed by normal SPH particles and thus require their own data structures.  We use Fortran \var{types} (equivalent to C structures) to hold sink data.  The main array that contains each sink structure is called \var{sinkdata} and elements can be accessed using the Fortran \% notation (e.g. the mass element of sink \var{s} is \var{sinkdata(s)\%m}).  


\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Units}
Dimensionless units are used in numerical simulations so that all 
values are as close to unity as possible, to avoid having very large 
or very small values that may result in significant rounding errors. 
\NAME contains a flexible system of units which allows the 
user to select from a wide range of commonly used astrophysical units, 
or easily construct their own set of units.  All variables related to 
units and scaling are determined in \var{units.F90}.  

\NAME uses a slightly different approach to scaling than DRAGON 
(which may cause some initial confusion since some variables with common names 
between the two have different functions).  Each quantity, \var{X}, has 
three scaling variables associated with it: \var{Xunit}, \var{Xscale} 
and \var{X\_SI}.  



\begin{itemize}
\item \var{Xunit} is a string which contains the name of the unit that 
the quantity \var{X} is measured in; e.g. for length units, \var{runit} 
may take the values \var{pc}, \var{au}, \var{r\_sun}, etc.   
All \var{Xunit} strings are defined in the parameters file.  
The available options in version 1.0 of the code are given in 
the following table: 

\item \var{Xscale} is a real variable that allows us to convert 
between physical and code units.  In order to convert any variable 
from physical to code units (where the physical variable is measured 
in units specified by \var{Xunit}), then we divide the physical unit 
by \var{Xscale}.  Conversely, to convert any code variable to 
physical units, we multiply the code value by \var{Xscale}
%, i.e.
%\begin{eqnarray}
%\var{X}_{\rm code} &= \frac{\var{X}_{\rm physical}}{\var{Xscale}}
%\end{eqnarray}
\item \var{X\_SI} is a real variable that allows us to convert between 
the unit specified by \var{Xunit} and S.I. units.  In order to convert 
from \var{Xunit} to S.I. units, we multiply the variable 
(in units of \var{Xunit}) by \var{X\_SI}.
\end{itemize}


In a self-gravitating code like \NAME, we choose a set of units so as 
to make the gravitational constant $G$ equal to unity.  
As with DRAGON, we are free to choose the 
values of \var{rscale} and \var{mscale}.  The value of \var{tscale} is 
then set to ensure \var{G = 1} in the new system of units.  Therefore, 
the value of \var{tscale} can be obtained using 
\begin{equation}
tscale \times t\_SI = \frac{\left( rscale \times r\_SI \right)^{3/2}} 
{\sqrt{G \times mscale \times m\_SI}}
\end{equation}
where \var{G} is the gravitational constant in c.g.s. units, i.e. 
$\var{G} = 6.67 \times 10^{-8} \, {\rm cm}^3\,{\rm g}^{-1}\,{\rm s}^{-2}$. 
All other scaling factors can be determined in a similar way using: 
\begin{equation}
vscale \times v\_SI = \frac{rscale \times r\_SI} {tscale \times t\_SI}
\end{equation}

\begin{equation}
ascale \times a\_SI = \frac{rscale \times r\_SI} {\left(tscale \times t\_SI \right)^2}
\end{equation}

\begin{equation}
rhoscale \times rho\_SI = \frac{mscale \times m\_SI} {\left(rscale \times r\_SI \right)^3}
\end{equation}

\begin{equation}
sigmascale \times sigma\_SI = \frac{mscale \times m\_SI} {\left(rscale \times r\_SI \right)^2}
\end{equation}

\begin{equation}
Pscale \times P\_SI = \frac{mscale \times m\_SI} {rscale \times r\_SI \times \left( tscale \times t\_SI \right)^2}
\end{equation}

\begin{equation}
fscale \times f\_SI = \frac{mscale \times m\_SI \times rscale \times r\_SI} {\left( tscale \times t\_SI \right)^2}
\end{equation}

\begin{equation}
Escale \times E\_SI = \frac{mscale \times m\_SI \times  rscale \times r\_SI} {\left( tscale \times t\_SI \right)^2}
\end{equation}

\begin{equation}
momscale \times mom\_SI = \frac{mscale \times m\_SI \times rscale \times r\_SI} {tscale \times t\_SI}
\end{equation}

\begin{equation}
angmomscale \times angmom\_SI = \frac{mscale \times m\_SI \times rscale^2 \times r\_SI^2}{tscale \times t\_SI}
\end{equation}
 
\begin{equation}
dmdtscale \times dmdt\_SI = \frac{mscale \times m\_SI}{tscale \times t\_SI}
\end{equation}

\begin{equation}
Lscale \times L\_SI = \frac{Escale \times E\_SI}{tscale \times t\_SI}
\end{equation}

\begin{equation}
kappascale \times kappa\_SI = \frac{\left(rscale \times r\_SI \right)^2}{mscale \times m\_SI}
\end{equation}

In MHD, we must also introduce the unit of charge and associated units such as magnetic field and current density.  As with gravitational problems, we can scale the units of the magnetic field such that the permiability of free space, $\mu_{0}$, is equal to unity.  {\bf to be completed}.

\begin{equation}
Jscale \times J\_SI = \frac{Qscale \times Q\_SI}
{tscale \times t\_SI \times rscale^2 \times r\_SI^2}
\end{equation}
\newline


\tablecaption{List of unit options in \NAME}
\tablehead{\hline \bf{Xunit}      & \bf{Options}    & \bf{Description}  \\ \hline}
\tabletail{\hline}
\tablelasttail{\hline}
%\begin{figure}
\begin{center}
\begin{supertabular}{|p{3cm}|p{3cm}|p{6cm}|}
\var{runit}     & \var{mpc}       & megaparsecs \\
                & \var{kpc}       & kiloparsecs \\
                & \var{pc}        & parsecs \\
                & \var{au}        & astronomical units \\
                & \var{r\_sun}    & solar radii \\
                & \var{r\_earth}  & Earth radii \\
                & \var{km}        & kilometres \\
                & \var{m}         & metres \\
                & \var{cm}        & centimetres \\ \hline
\var{munit}     & \var{m\_sun}    & solar masses \\ 
                & \var{m\_jup}    & Jupiter masses \\
                & \var{m\_earth}  & Earth masses \\
                & \var{kg}        & kilograms \\
                & \var{g}         & grams \\ \hline
\var{tunit}     & \var{gyr}       & gigayears \\
                & \var{myr}       & megayears \\
                & \var{yr}        & years \\
                & \var{day}       & days \\
                & \var{sec}       & seconds \\ \hline
\var{vunit}     & \var{km\_s}     & kilometres per second  \\
                & \var{au\_yr}    & astronomical units per year \\
                & \var{m\_s}      & metres per second \\
                & \var{cm\_s}     & centimetres per second \\ \hline
\var{aunit}     & \var{km\_s2}    & kilometres per second squared \\
                & \var{au\_yr2}   & astronomical units per year squared \\
                & \var{m\_s2}     & metres per second squared \\
                & \var{cm\_s2}    & centimetres per second squared \\ \hline
\var{rhounit}   & \var{m\_sun\_pc3} & solar masses per cubic parsec \\
                & \var{g\_cm3}     & grams per cubic centimetre \\ \hline
\var{sigmaunit} & \var{m\_sun\_pc2} & solar masses per parsec squared \\
                & \var{g\_cm2}     & grams per centimetre squared \\ \hline
\var{Punit}     & \var{Pa}        & pascals \\
                & \var{bar}       & bars \\
                & \var{g\_cms2}    & grams per centimetre per second squared \\
\hline
\var{funit}     & \var{N}         & newtons  \\ 
                & \var{dyn}       & dynes    \\ \hline
\var{Eunit}     & \var{J}         & joules \\
                & \var{erg}       & ergs \\
                & \var{GJ}        & gigajoules \\ \hline
\var{momunit}   & \var{m\_sunkm\_s} & solar masses kilometres per second \\
                & \var{m\_sunau\_yr}& solar masses astronomical units per year \\
                & \var{kgm\_s}    & kilomgram metres per second \\
\hline
\var{angmomunit}& \var{kgm2\_s}  & kilogram metres squared per second \\
                & \var{gcm2\_s}   & gram centimetres squared per second \\ 
\hline
\var{angvelunit}& \var{rad\_s}   & radians per second \\
\hline
\var{dmdtunit}  & \var{m\_sun\_myr} & solar masses per megayear \\
                & \var{m\_sun\_yr}  & solar masses per year \\
                & \var{kg\_s}       & kilograms per second \\
                & \var{g\_s}        & grams per second \\ \hline
\var{Lunit}     & \var{L\_sun}    & solar luminosities \\ \hline
\var{kappaunit} & \var{m2\_kg}    & metre squared per kilogram \\
                & \var{cm\_g}     & centimetre per gram \\ 
\hline
\var{Bunit}     & \var{tesla}     & tesla \\
                & \var{gauss}     & gauss \\
\hline
\var{Qunit}     & \var{C}         & coulombs \\
\hline
\var{Junit}     & \var{C\_m2\_s}    & coulombs per second per metre squared \\
\hline
\var{uunit}     & \var{J\_kg}     & Joules per kilogram \\
                & \var{erg\_g}    & ergs per gramme \\
\end{supertabular}
\end{center}


\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{File formats}
\NAME \VERNO uses both the DRAGON file format and the native \NAME file format for reading in initial conditions and writing out snapshots.  Unlike in DRAGON, the format of the initial conditions file need not be the same as the format of the output snapshots.  This is controlled by the two input parameters in the parameters file, \var{in\_file\_form} and \var{out\_file\_form}.  The possible values for these parameters are : 
\begin{itemize}
\item \var{ascii} - Simple (ASCII) column format
\item \var{dragon\_form} - Formatted (ASCII) DRAGON snapshot files
\item \var{dragon\_unform} - Unformatted (binary) DRAGON snapshot files
\item \var{seren\_form} - Formatted (ASCII) \NAME snapshot files
\item \var{seren\_unform} - Unformatted (binary) \NAME snapshot files (Not yet working)
\end{itemize}

As well as standard snapshot files, \NAME can also produce a simple ASCII 
output which is useful for debugging purposes.  This can be enabled by using the {\rm -DDEBUG\_PLOT\_DATA} compiler flag.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ASCII format}
Seren can use a simple flexible ASCII column-format.  The data is stored in columns with width $N_{_{\rm COLUMNS}}$ and length $N$ (where $N$ is the total number of particles of all types).  The data descriptor of each column is contained in a file labelled \var{asciicolumns.dat} (a template copy should be stored in the \var{/datafiles} sub-directory).  The possible data descriptors currently enabled in \NAME are
\begin{itemize} 
\item \var{ptype} - Particle type.  The following particle types are available in \NAME : 
\begin{itemize}
\item -1 : sink/star
\item  0 : dead particle
\item  1 : gas
\item  6 : boundary particle
\item  9 : ICM particle
\item 10 : cold-dark matter particle
\end{itemize}
\item \var{x} or \var{y} or {z} - Cartesian position coordinates
\item \var{vx} or \var{vy} or \var{vz} - Cartesian velocity componenets
\item \var{h} - Smoothing length
\item \var{m} - Mass
\item \var{u} - Specific internal energy
\end{itemize}
The only constraint on the column order is that the first column must be \var{ptype}.  Thereafter, the remaining columns can be arranged in any order.  In the file containing the data, the data must match up to the chosen columns correctly, or the particle data will be read-in incorrectly.  All physical quantities are measured in the units defined in the \var{params.dat} file.  Due to the simplicity of this format, it contains no extra information (e.g. time, gamma, etc.), and therefore is perhaps not of long-term practical use, but should be suitable for those who wish to generate their own initial conditions from other programmes without learning all the complications of the other available formats.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Dragon format}
To be written

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Seren format}
To be written




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Structure of code}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Basic directory structure}
Subroutines in \NAME are not all contained in a single source directory, 
but are grouped in several sub-directories depending on their purpose. 
In version 1.0, the following sub-directories exist : 
\begin{itemize}
\item \var{/\name/src/advance} - integration routines
\item \var{/\name/src/analyse} - analysis routines
\item \var{/\name/src/BHtree} - Barnes-Hut octal tree subroutines
\item \var{/\name/src/binarytree} - Binary-number tree subroutines
\item \var{/\name/datafiles} - Contains initial conditions parameters files
\item \var{/\name/docs} - Contains latest version of the userguide
\item \var{/\name/src/gravity} - subroutines that calculate gravitational forces
\item \var{/\name/src/headers} - macro and modules files
\item \var{/\name/src/healpix} - HEALPix ioniaztion routines
\item \var{/\name/src/ic} - programs to generate initial conditions for 
regularly used configurations (e.g. relaxed rectangular cubes, 
spheres)
\item \var{/\name/src/io} - subroutines that read and write files
\item \var{/\name/src/main} - contains important and commonly used 
subroutines
\item \var{/\name/src/mhd} - contains magneto-hydrodynamics routines
\item \var{/\name/src/nbody} - N-body routines
\item \var{/\name/src/nbody\_sim} - N-body simulation subroutines
\item \var{/\name/src/nbody\_sph\_sim} - Hybrid N-body/SPH simulation routines
\item \var{/\name/src/radiation} - contains radiation transfer subroutines
\item \var{/\name/src/setup} - contains subroutines called during initialization of \NAME .
\item \var{/\name/src/sinks} - subroutines that search for, create and 
advance sink particles. 
\item \var{/\name/src/sorts} - subroutines for sorting lists
\item \var{/\name/src/sph} - subroutines that perform important SPH functions 
\item \var{/\name/src/sph\_sim} - SPH simulation routines
(e.g. h-finding, neighbour searching)  
\item \var{/\name/src/tests} - test programs
\item \var{/\name/src/timestep} - timestepping routines
\item \var{/\name/testsuite} - bash script for running batch tests of seren
\end{itemize}


%\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Variable conventions}
In \NAME, the names of all commonly used local variables are kept as 
consistent as possible between different subroutines.  
Here we list the names of all common local integer and real variables.  

\subsection{Integer variables}
\begin{tabular}{lll}
\var{c}  &  &  Cell identifier \\
\var{cc} &  &  Child cell identifier \\
\var{i}  &  &  Auxiliary counter (often used when looping over neighbour lists) \\
\var{k}  &  &  Dimension counter \\
\var{l}  &  &  Level counter (for BH tree and HEALPix) \\
\var{p}  &  &  Particle identifier  \\
\var{pp} &  &  Neighbour identifier \\
\var{pp\_pot} & & No. of potential neighbours (e.g. after a tree walk) \\
\var{pp\_templist(1:pp\_limit)} &  & Temporary list of neighbour identifiers \\
\var{pp\_tot} & & Total number of neighbours for particle p \\
\var{s}  &  &  Sink particle identifier \\
\var{ss} &  &  Secondary sink counter
\end{tabular}

\subsection{Real variables}
\begin{tabular}{lll}
\var{dr(1:NDIM)}  &  &  Relative position vector \\
\var{drmag}       &  &  Distance \\
\var{drsqd}       &  &  Distance squared \\
\var{dr\_unit(1:NDIM)} &  &  Unit position vector \\
\var{hp}          &  &  Smoothing length of particle p \\
\var{hpp}         &  &  Smoothing length of neighbouring particle pp \\
\var{mp}          &  &  Mass of particle p \\
\var{mpp}         &  &  Mass of neighbouring particle pp \\
\var{ms}          &  &  Mass of sink particle s \\
\var{invdrmag}    &  &  Reciprocal of distance, i.e. 1 / drmag \\
\var{invdrsqd}    &  &  Reciprocal of distance squared, i.e. 1 / drsqd \\
\var{invhp}       &  &  Reciprical of smoothing length of p, i.e. 1 / hp \\
\var{invhpp}      &  &  Reciprical of smoothing length of pp, i.e. 1 / hpp \\
\var{qc(1:NQUAD)} &  &  Quadrupole moment tensor for cell c \\
\var{rp(1:NDIM)}  &  &  Position of particle p \\
\var{rpp(1:NDIM)} &  &  Position of neighbouring particle pp  \\
\var{rs(1:NDIM)}  &  &  Position of sink particle s \\
\var{sound\_p}    &  &  Sound speed of particle p \\
\var{sound\_pp}   &  &  Sound speed of neighbouring particle pp \\
\var{up}          &  &  Specific internal energy of particle p \\
\var{upp}         &  &  Specific internal energy of neighbouring particle pp \\
\var{vp(1:NDIM)}  &  &  Velocity of particle p \\
\var{vpp(1:NDIM)} &  &  Velocity of neighbouring particle pp \\
\var{vs(1:NDIM)}  &  &  Velocity of sink particle s \\
\end{tabular}



\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

